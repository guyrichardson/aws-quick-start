{
    "AWSTemplateFormatVersion" : "2010-09-09",
    "Description" : "AWS CloudFormation Template for setting up Humio performance test",
    "Parameters" : {
        "WebAccess": {
            "Description" : "Cidr restricting access to Humio. Use 0.0.0.0/0 for unrestricted access",
            "Type" : "String",
            "AllowedPattern" : "((\\d{1,3})\\.){3}\\d{1,3}/\\d{1,2}"
        },

        "KeyName": {
            "Description" : "Name of an existing EC2 KeyPair to enable SSH access to the instances",
            "Type": "AWS::EC2::KeyPair::KeyName",
            "ConstraintDescription" : "must be the name of an existing EC2 KeyPair."
        },

        "login": {
            "Description" : "Login parameters to docker login: '-u <username> -p <password>",
            "Type": "String"
        },

        "VolumeSize" : {
            "Description" : "Size (in GB) of the data volume created",
            "Type" : "Number",
            "Default" : "100"
        },

        "HumioInstanceType" : {
            "Description" : "Humio EC2 instance type",
            "Type" : "String",
            "Default" : "m4.xlarge",
            "AllowedValues" : [ "t2.small", "t2.medium", "t2.large", "m4.large", "m4.xlarge", "m4.2xlarge", "m4.4xlarge", "m4.10xlarge"],
            "ConstraintDescription" : "must be a valid EC2 instance type."
        }
    },

    "Mappings" : {
        "HumioAMI" : {
            "us-east-1": { "id": "ami -8d6642f7" },
            "ap-south-1": { "id": "ami -45ca992a"},
            "eu-west-3": { "id": "ami -08ac1a75"},
            "eu-west-2": { "id": "ami -26ba5f41"},

            "eu-west-1": { "id": "ami-1b791862"},

            "ap-northeast-2": { "id": "ami -e5a1038b"},
            "ap-northeast-1": { "id": "ami -e52c5a83"},
            "sa-east-1": { "id": "ami -6e3e7002"},
            "ca-central-1": { "id": "am i-03a22667"},
            "ap-southeast-1": { "id": "ami -a883c2d4"},
            "ap-southeast-2": { "id": "ami -c52ad1a7"},
            "eu-central-1": { "id": "ami -fca5c193"},
            "us-east-2": { "id": "ami -9a88bdff"},
            "us-west-1": { "id": "ami -0d5f516d"},
            "us-west-2": { "id": "ami -6be76013"}
        }
    },

    "Resources" : {

        "HumioInstance": {
            "Type" : "AWS::EC2::Instance",
            "Properties": {
                "ImageId" : { "Fn::FindInMap" : [ "HumioAMI", { "Ref" : "AWS::Region" }, "id" ] },
                "InstanceType"   : { "Ref" : "HumioInstanceType" },
                "BlockDeviceMappings": [
                    {
                        "DeviceName": "/dev/sda1",
                        "Ebs": {
                            "VolumeSize": "8"
                        }
                    },
                    {
                        "DeviceName": "/dev/sdh",
                        "Ebs": {
                            "DeleteOnTermination" : "False",
                            "VolumeSize": {"Ref": "VolumeSize"}
                        }
                    }
                ],
                "SecurityGroups" : [ {"Ref" : "SecurityGroup"} ],
                "KeyName"        : { "Ref" : "KeyName" },
                "UserData"       : { "Fn::Base64" : { "Fn::Join" : ["", [
                    "#!/bin/bash -xe\n",
                    "echo \"=== Begin =========================================================================================================\"\n",
                    "mkdir -p /opt\n",
                    "cd /opt\n",
                    "apt-get update\n",
                    "apt-get -y install git\n",
                    "git clone https://github.com/humio/humio-operations.git\n",
                    "cd humio-operations\n",
                    "echo \"=== Provisioning =========================================================================================================\"\n",
                    "bash aws/setup-server.sh \"", { "Ref" : "login" }, "\"\n",
                    "echo \"=== Done =========================================================================================================\"\n"
		]]}}
            }
        },

        "SecurityGroup" : {
            "Type" : "AWS::EC2::SecurityGroup",
            "Properties" : {
                "GroupDescription" : "Enable HTTP access via port 80 locked down to the ELB and SSH access",
                "SecurityGroupIngress" : [
                    {
                        "IpProtocol" : "tcp",
                        "FromPort" : "8080",
                        "ToPort" : "8080",
                        "CidrIp" : { "Ref": "WebAccess" }
                    },
                    {
                        "IpProtocol" : "tcp",
                        "FromPort" : "22",
                        "ToPort" : "22",
                        "CidrIp" : "0.0.0.0/0"
                    }
                ]
            }
        }
    },

    "Outputs" : {
        "WebsiteURL" : {
            "Description" : "URL for newly created Humio stack",
            "Value" : { "Fn::Join" : ["", ["http://", { "Fn::GetAtt" : [ "HumioInstance", "PublicDnsName" ]},":8080"]]}
        }
    }
}